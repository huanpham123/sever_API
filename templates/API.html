<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Voice Chat vá»›i Gemini</title>
</head>
<body>
  <h1>Thu Ã¢m vÃ  há»i Gemini</h1>
  <button id="startBtn">ğŸ™ï¸ Báº¯t Ä‘áº§u thu Ã¢m</button>
  <button id="stopBtn" disabled>ğŸ›‘ Dá»«ng vÃ  gá»­i</button>
  <p id="status">Tráº¡ng thÃ¡i: Sáºµn sÃ ng</p>
  <audio id="responseAudio" controls></audio>

  <!-- Sá»­ dá»¥ng phiÃªn báº£n má»›i nháº¥t cá»§a RecordRTC -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/RecordRTC/5.6.2/RecordRTC.min.js"></script>
  <script>
    let recorder;
    let audioStream;
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const statusP = document.getElementById('status');
    const responseAudio = document.getElementById('responseAudio');

    // Kiá»ƒm tra trÃ¬nh duyá»‡t há»— trá»£
    function checkBrowserSupport() {
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        statusP.innerText = 'TrÃ¬nh duyá»‡t khÃ´ng há»— trá»£ ghi Ã¢m';
        startBtn.disabled = true;
        return false;
      }
      return true;
    }
    checkBrowserSupport();

    startBtn.onclick = async () => {
      if (!checkBrowserSupport()) return;
      
      statusP.innerText = 'Äang yÃªu cáº§u quyá»n truy cáº­p mic...';
      try {
        audioStream = await navigator.mediaDevices.getUserMedia({ 
          audio: {
            echoCancellation: true,
            noiseSuppression: true,
            channelCount: 1
          }
        });
        
        statusP.innerText = 'Äang thu Ã¢m...';
        
        // Khá»Ÿi táº¡o recorder vá»›i Ä‘á»‹nh dáº¡ng WebM (Ä‘Æ°á»£c há»— trá»£ rá»™ng rÃ£i)
        recorder = new RecordRTC(audioStream, {
          type: 'audio',
          mimeType: 'audio/webm',
          sampleRate: 16000,
          desiredSampRate: 16000,
          numberOfAudioChannels: 1,
          timeSlice: 1000,
          recorderType: RecordRTC.StereoAudioRecorder
        });
        
        recorder.startRecording();
        startBtn.disabled = true;
        stopBtn.disabled = false;
      } catch (err) {
        statusP.innerText = 'Lá»—i: ' + err.message;
        console.error('Lá»—i khi báº¯t Ä‘áº§u ghi Ã¢m:', err);
        startBtn.disabled = false;
      }
    };

    stopBtn.onclick = async () => {
      if (!recorder) return;
      
      statusP.innerText = 'Äang dá»«ng ghi Ã¢m...';
      stopBtn.disabled = true;
      
      try {
        // Dá»«ng ghi Ã¢m vÃ  láº¥y dá»¯ liá»‡u
        await new Promise((resolve) => {
          recorder.stopRecording(resolve);
        });
        
        // Dá»«ng cÃ¡c track Ã¢m thanh
        audioStream.getTracks().forEach(track => track.stop());
        
        statusP.innerText = 'Äang gá»­i dá»¯ liá»‡u...';
        console.log('ÄÃ£ ghi Ã¢m xong, Ä‘ang gá»­i dá»¯ liá»‡u...');
        
        // Láº¥y blob Ã¢m thanh
        const blob = recorder.getBlob();
        console.log('KÃ­ch thÆ°á»›c blob:', blob.size, 'bytes', 'Loáº¡i:', blob.type);
        
        // Gá»­i lÃªn server
        const formData = new FormData();
        formData.append('audio', blob, 'recording.webm');
        
        const res = await fetch('/process', {
          method: 'POST',
          body: formData
        });
        
        if (!res.ok) {
          throw new Error(`Lá»—i server: ${res.status}`);
        }
        
        // Xá»­ lÃ½ pháº£n há»“i
        const audioBlob = await res.blob();
        console.log('Nháº­n Ä‘Æ°á»£c audio pháº£n há»“i:', audioBlob.size, 'bytes', 'Loáº¡i:', audioBlob.type);
        
        const audioUrl = URL.createObjectURL(audioBlob);
        responseAudio.src = audioUrl;
        responseAudio.onerror = () => {
          statusP.innerText = 'Lá»—i phÃ¡t Ã¢m thanh';
          console.error('KhÃ´ng thá»ƒ phÃ¡t Ã¢m thanh');
        };
        
        // Tá»± Ä‘á»™ng phÃ¡t
        responseAudio.play().catch(err => {
          statusP.innerText = 'Lá»—i khi phÃ¡t Ã¢m thanh: ' + err.message;
          console.error('Lá»—i phÃ¡t Ã¢m thanh:', err);
        });
        
        statusP.innerText = 'HoÃ n thÃ nh! Nháº¥n nÃºt thu Ã¢m Ä‘á»ƒ tiáº¿p tá»¥c';
      } catch (err) {
        statusP.innerText = 'Lá»—i: ' + err.message;
        console.error('Lá»—i trong quÃ¡ trÃ¬nh xá»­ lÃ½:', err);
      } finally {
        startBtn.disabled = false;
      }
    };
  </script>
</body>
</html>
