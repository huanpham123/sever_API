<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Voice Chat với Gemini</title>
</head>
<body>
  <h1>Thu âm và hỏi Gemini</h1>
  <button id="startBtn">🎙️ Bắt đầu thu âm</button>
  <button id="stopBtn" disabled>🛑 Dừng và gửi</button>
  <p id="status"></p>
  <audio id="responseAudio" controls></audio>

  <!-- RecordRTC library -->
  <script src="https://cdn.webrtc-experiment.com/RecordRTC.js"></script>
  <script>
    let recorder;
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const statusP = document.getElementById('status');

    startBtn.onclick = async () => {
      statusP.innerText = 'Đang thu âm...';
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        recorder = RecordRTC(stream, {
          type: 'audio',
          mimeType: 'audio/wav',
          recorderType: StereoAudioRecorder,
          numberOfAudioChannels: 1,
          timeSlice: 1000,
        });
        recorder.startRecording();
        startBtn.disabled = true;
        stopBtn.disabled = false;
      } catch (err) {
        statusP.innerText = 'Lỗi truy cập mic: ' + err;
        console.error(err);
      }
    };

    stopBtn.onclick = () => {
      statusP.innerText = 'Đang xử lý...';
      stopBtn.disabled = true;
      recorder.stopRecording(async () => {
        const blob = recorder.getBlob();
        console.log('Recorded blob size:', blob.size, 'type:', blob.type);
        const formData = new FormData();
        formData.append('audio', blob, 'recording.wav');
        try {
          const res = await fetch('/process', { method: 'POST', body: formData });
          const audioBlob = await res.blob();
          const url = URL.createObjectURL(audioBlob);
          const audioEl = document.getElementById('responseAudio');
          audioEl.src = url;
          audioEl.play();
          statusP.innerText = 'Đã xử lý xong ✅';
        } catch (err) {
          statusP.innerText = 'Lỗi xử lý: ' + err;
          console.error(err);
        }
        startBtn.disabled = false;
      });
    };
  </script>
</body>
</html>
